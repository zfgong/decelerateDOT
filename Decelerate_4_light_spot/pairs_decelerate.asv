function [point_min, point_max, pairs_decelerate_temp] = pairs_decelerate(speed, kernel, peakdet_lambda,threshold_min,threshold_max) %12.03 change
% 2016-10-22, add threshold_min and threshold_max
%threshold = 0.05; % 5% of decrease in cmspeed peaks is used to define a decrease period

    data = filter2(kernel, speed);
    point_max = peakdet(data, peakdet_lambda);
    point_min = peakdet(-data, peakdet_lambda);
    point_min(:,2) = - point_min(:,2);
    point_min(find(point_min(:,2)==0),:) = []; % remove the point_min points at 0 resulted from bad frames
%     display('point_min');
%     display(point_min);
    
    n = size(point_min, 1); % n is the total number of mini- or max- peaks
    if point_max(1,1) >= point_min(1,1)
        point_min = point_min(2:n,:);
        n = n - 1;
    end
    if point_max(size(point_max, 1), 1) <= point_min(n, 1) 
        point_min = point_min(1:(n-1), :);
        n = n - 1;
    end
    
    pairs_decelerate_t_origin =[]; %�ʼ�ҵ������ÿ���������ڵ�������ֵ��Ӧ֡������ɵ�����
    for i=1:(n-1)
        if (point_min(i,2) - point_min(i+1, 2)) > (threshold_min * point_min(i, 2))
            cond1 = (point_max(i,2) - point_max(i+1,2)) > (threshold_max*point_max(i,2));
            cond2 = (point_max(i+1,2) - point_max(i+2,2)) > (threshold_max*point_max(i+1,2));
            % add
            if cond1 | cond2
                pairs_decelerate_t_origin= [pairs_decelerate_t_origin; point_min(i,1), point_min(i+1,1)];
            end
        end
%              if (point_max(i,2) - point_max(i+1,2)) > 0
%                   if (point_min(i,2) - point_min(i+1, 2)) > 0
%                        pairs_decelerate_t_origin= [pairs_decelerate_t_origin; point_min(i,1), point_min(i+1,1)];
%                   end      
%              else
%                   if (point_min(i,2) - point_min(i+1, 2)) > 0.5*point_min(i,2) 
%                         pairs_decelerate_t_origin= [pairs_decelerate_t_origin; point_min(i,1), point_min(i+1,1)];
%                   end
%              end     %11.05 change
    end
    
    if ~isempty(pairs_decelerate_t_origin)
       pairs_decelerate_temp = [pairs_decelerate_t_origin(1,:)];% ȡԭʼ���ٵĹ�ֵϵ�еĳ�ʼ���ٹ�ֵ֡
    else 
        pairs_decelerate_temp= [];
    end
    now_index = 1;
    for i=2:size(pairs_decelerate_t_origin,1)
        if pairs_decelerate_t_origin(i, 1) == pairs_decelerate_temp(now_index, 2)
            pairs_decelerate_temp(now_index, 2) = pairs_decelerate_t_origin(i,2);
        else
            now_index = now_index + 1;
            pairs_decelerate_temp = [pairs_decelerate_temp; pairs_decelerate_t_origin(i,:)];% pairs_decelerate_t��������ȷ��ÿ�μ��ٵĹ�ֵ�Ե�֡��
        end
    end
end
